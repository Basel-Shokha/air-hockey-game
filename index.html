<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IoT Air Hockey - Connected</title>
    <style>
        :root { --primary: #00f2ff; --bg: #0a0a0a; --danger: #ff004c; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; cursor: none; }
        
        /* Setup Screen */
        #setup-layer { 
            position: absolute; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1a1a1a, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 100; cursor: default;
        }
        .form-container { 
            background: rgba(255, 255, 255, 0.05); padding: 30px; 
            border-radius: 15px; backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 242, 255, 0.3); text-align: center;
            width: 80%; max-width: 400px;
        }
        input, select, button { 
            display: block; width: 100%; padding: 12px; margin: 15px 0; 
            border-radius: 8px; border: 1px solid #444; background: #222; color: white;
            font-size: 16px; box-sizing: border-box;
        }
        button { background: var(--primary); color: black; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; letter-spacing: 1px; }
        button:active { transform: scale(0.98); }

        /* Stats HUD */
        #stats-hud { 
            position: absolute; top: 20px; width: 100%; display: none; 
            justify-content: space-around; font-size: 18px; z-index: 5;
            font-weight: bold; text-shadow: 0 0 10px black; pointer-events: none;
        }

        canvas { display: block; margin: auto; }
        #led-indicator { position: absolute; top: 0; width: 100%; height: 8px; z-index: 20; transition: background 0.2s; box-shadow: 0 0 15px var(--primary); }
    </style>
</head>
<body>

    <div id="led-indicator"></div>
    
    <!-- Local Audio Element -->
    <audio id="bgMusic" loop preload="auto">
        <source src="background-music.mp3" type="audio/mpeg">
    </audio>

    <div id="setup-layer">
        <div class="form-container">
            <h1 style="color: var(--primary);">SYSTEM LOGIN</h1>
            <input type="text" id="pName" placeholder="Enter Player ID..." value="Player 1">
            
            <label>Tactical Profile (Mood):</label>
            <select id="mMood">
                <option value="calm">Defensive (Calm)</option>
                <option value="aggressive">Aggressive (Angry)</option>
                <option value="joker">The Joker (Tricky)</option>
            </select>

            <label>Motor Difficulty:</label>
            <select id="mDiff">
                <option value="0.03">Rookie</option>
                <option value="0.08">Pro</option>
                <option value="0.15">God Mode</option>
            </select>

            <button onclick="bootGame()">CONNECT TO TABLE</button>
            <p style="font-size: 12px; color: #666;">*Music will start on click</p>
        </div>
    </div>

    <div id="stats-hud">
        <div id="pLabel" style="color: var(--primary)">Player: 0</div>
        <div id="aiLabel" style="color: var(--danger)">AI: 0</div>
    </div>

    <canvas id="game"></canvas>

    <script>
        // --- 1. CONFIG & GLOBALS ---
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const setup = document.getElementById('setup-layer');
        const hud = document.getElementById('stats-hud');
        const led = document.getElementById('led-indicator');
        const bgMusic = document.getElementById('bgMusic');

        // Game State
        let gameState = { player: "", scoreP: 0, scoreAI: 0, mood: "", difficulty: 0.05, active: false };
        
        // Objects
        let ball = { x: 0, y: 0, dx: 0, dy: 0, r: 15, speed: 7 };
        let p1 = { x: 0, y: 0, r: 35, color: '#00f2ff' };
        let ai = { x: 0, y: 0, r: 35, color: '#ff004c' };

        // --- 2. AUDIO SYSTEM ---
        function speak(text) {
            if (!window.speechSynthesis) return;
            
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Mood Logic
            if (gameState.mood === 'joker') {
                utterance.pitch = 1.6; 
                utterance.rate = 1.3;
            } else if (gameState.mood === 'aggressive') {
                utterance.pitch = 0.6; 
                utterance.rate = 1.1;
            } else {
                utterance.pitch = 1.0; 
                utterance.rate = 1.0;
            }

            utterance.volume = 1.0;
            
            try {
                window.speechSynthesis.speak(utterance);
            } catch(e) {
                console.log("Speech error:", e);
            }
        }

        // --- 3. INPUT HANDLING ---
        function updatePaddlePos(clientX, clientY) {
            let rect = canvas.getBoundingClientRect();
            let x = clientX - rect.left;
            let y = clientY - rect.top;
            
            // Constrain player to bottom half
            p1.x = x;
            if(y < canvas.height / 2 + p1.r) p1.y = canvas.height / 2 + p1.r;
            else p1.y = y;
        }

        window.addEventListener('mousemove', e => { if(gameState.active) updatePaddlePos(e.clientX, e.clientY); });
        window.addEventListener('touchmove', e => { 
            if(gameState.active) {
                e.preventDefault(); 
                updatePaddlePos(e.touches[0].clientX, e.touches[0].clientY); 
            }
        }, {passive: false});

        // --- 4. GAME LOGIC ---
        function bootGame() {
            gameState.player = document.getElementById('pName').value || "User";
            gameState.mood = document.getElementById('mMood').value;
            gameState.difficulty = parseFloat(document.getElementById('mDiff').value);
            gameState.active = true;

            setup.style.display = 'none';
            hud.style.display = 'flex';
            
            // Start Background Music
            bgMusic.volume = 0.5;
            bgMusic.play().catch(e => console.log("Audio play failed:", e));

            // Intro Speech
            setTimeout(() => {
                if (gameState.mood === 'joker') speak("Welcome to the circus, " + gameState.player + "!");
                else if (gameState.mood === 'aggressive') speak("Prepare to be deleted, " + gameState.player + ".");
                else speak("System initialized. Good luck, " + gameState.player + ".");
            }, 300);

            init();
            animate();
        }

        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            resetBall();
            p1.x = canvas.width/2; p1.y = canvas.height - 100;
            ai.x = canvas.width/2; ai.y = 100;
            updateHUD();
        }

        function resetBall() {
            ball.x = canvas.width/2; ball.y = canvas.height/2;
            ball.dx = 0; ball.dy = 0;
            
            setTimeout(() => {
                let dir = Math.random() > 0.5 ? 1 : -1;
                ball.dx = (Math.random() * 4 - 2); 
                ball.dy = dir * ball.speed;
            }, 1000);
        }

        function updateHUD() {
            document.getElementById('pLabel').innerText = `${gameState.player}: ${gameState.scoreP}`;
            document.getElementById('aiLabel').innerText = `AI: ${gameState.scoreAI}`;
            
            if(gameState.scoreAI > gameState.scoreP) led.style.background = "var(--danger)";
            else if (gameState.scoreP > gameState.scoreAI) led.style.background = "var(--primary)";
            else led.style.background = "white";
        }

        function checkCollision(paddle) {
            let dx = ball.x - paddle.x;
            let dy = ball.y - paddle.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < ball.r + paddle.r) {
                let angle = Math.atan2(dy, dx);
                let speed = Math.sqrt(ball.dx*ball.dx + ball.dy*ball.dy);
                speed = Math.min(speed * 1.05, 15); 

                ball.dx = Math.cos(angle) * speed;
                ball.dy = Math.sin(angle) * speed;
                
                let overlap = (ball.r + paddle.r) - dist;
                ball.x += Math.cos(angle) * overlap;
                ball.y += Math.sin(angle) * overlap;

                led.style.boxShadow = "0 0 50px white";
                setTimeout(() => led.style.boxShadow = "0 0 15px var(--primary)", 100);
            }
        }

        function animate() {
            if(!gameState.active) return;
            requestAnimationFrame(animate);

            ctx.fillStyle = "rgba(10, 10, 10, 0.4)"; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 4;
            ctx.stroke();

            let targetX = ball.x;
            if(gameState.mood === 'joker' && Math.random() > 0.95) targetX = Math.random() * canvas.width;
            
            ai.x += (targetX - ai.x) * gameState.difficulty;
            if(ai.x < ai.r) ai.x = ai.r;
            if(ai.x > canvas.width - ai.r) ai.x = canvas.width - ai.r;

            ball.x += ball.dx;
            ball.y += ball.dy;

            if(ball.x + ball.r > canvas.width || ball.x - ball.r < 0) {
                ball.dx = -ball.dx;
            }

            checkCollision(p1);
            checkCollision(ai);

            if(ball.y < 0) {
                gameState.scoreP++;
                speak("Point for " + gameState.player);
                updateHUD();
                resetBall();
            } else if(ball.y > canvas.height) {
                gameState.scoreAI++;
                if(gameState.mood === 'aggressive') speak("Too easy.");
                else if(gameState.mood === 'joker') speak("Ha ha ha!");
                else speak("Point for AI.");
                updateHUD();
                resetBall();
            }

            // Draw AI
            ctx.beginPath();
            ctx.arc(ai.x, ai.y, ai.r, 0, Math.PI * 2);
            ctx.fillStyle = ai.color;
            ctx.shadowBlur = 20; ctx.shadowColor = ai.color;
            ctx.fill();
            ctx.closePath();

            // Draw Player
            ctx.beginPath();
            ctx.arc(p1.x, p1.y, p1.r, 0, Math.PI * 2);
            ctx.fillStyle = p1.color;
            ctx.shadowBlur = 20; ctx.shadowColor = p1.color;
            ctx.fill();
            ctx.closePath();

            // Draw Ball
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
            ctx.fillStyle = "white";
            ctx.shadowBlur = 15; ctx.shadowColor = "white";
            ctx.fill();
            ctx.closePath();
            
            ctx.shadowBlur = 0;
        }
    </script>
</body>
</html>
